# Use the latest 2.1 version of CircleCI pipeline process engine.
# See: https://circleci.com/docs/2.0/configuration-reference
version: 2.1

# Orbs are reusable packages of CircleCI configuration that you may share across projects, enabling you to create encapsulated, parameterized commands, jobs, and executors that can be used across multiple projects.
# See: https://circleci.com/docs/2.0/orb-intro/
orbs:
   ruby: circleci/ruby@1.2.0
   node: circleci/node@5.0.0

# Define a job to be invoked later in a workflow.
# See: https://circleci.com/docs/2.0/configuration-reference/#jobs
jobs:
   build:
      docker:
       - image: cimg/ruby:2.7.5-node
         environment:
            POSTGRES_HOST_AUTH_METHOD: trust
      executor: ruby/default
      steps:
       - checkout
       # - run: gem install bundler -v 2.1.4
       - run: bundle install
       # - run: yarn
   test:  # our next job, called "test"
      # we run "parallel job containers" to enable speeding up our tests;
      # this splits our tests across multiple containers.
      parallelism: 3
      # here we set TWO docker images.
      docker:
       - image: cimg/ruby:2.7.5-node
       - image: circleci/redis:6.2.6-alpine
       - image: circleci/postgres:12
         auth:
            username: dneslov
            password: $DOCKERHUB_PASSWORD  # context / project UI env-var reference
         environment: # add POSTGRES environment variables.
            POSTGRES_HOST_AUTH_METHOD: trust
            POSTGRES_USER: dneslov
            POSTGRES_DB: dneslov_test
            POSTGRES_PASSWORD: ""
      environment:
         BUNDLE_JOBS: "3"
         BUNDLE_RETRY: "3"
         PGHOST: 127.0.0.1
         PGUSER: dneslov
         PGPASSWORD: ""
         RAILS_ENV: test
         PARALLEL_WORKERS: "1"
         REDIS_CACHE_URL: redis://127.0.0.1:6379
         REDIS_QUEUE_URL: redis://127.0.0.1:6379
      steps:
       - checkout
       - ruby/install-deps
         # - node/install-packages:
         #   pkg-manager: yarn
         # Here we make sure that the secondary container boots
         # up before we run operations on the database.
       - run:
            name: Wait for DB
            command: dockerize -wait tcp://localhost:5432 -timeout 1m
       - run:
            name: Database setup
            command: bundle exec rails db:schema:load --trace
       # Run rspec in parallel
       - run:
            command: bundle exec rake
# Invoke jobs via workflows
# See: https://circleci.com/docs/2.0/configuration-reference/#workflows
workflows:
   version: 2
   build_and_test:     # The name of our workflow is "build_and_test"
      jobs:             # The list of jobs we run as part of this workflow.
       - build         # Run build first.
       - test:         # Then run test,
            requires:   # Test requires that build passes for it to run.
             - build   # Finally, run the build job.
